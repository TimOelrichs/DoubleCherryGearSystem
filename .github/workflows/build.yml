name: Build GearSystem Libretro Core

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [created]
  workflow_dispatch:  # Manueller Trigger von GitHub UI

env:
  CORE_NAME: gearsystem_libretro
  BUILD_DIR: platforms/libretro

jobs:
  # Linux Builds
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [unix]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build for ${{ matrix.platform }}
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          make clean
          make platform=${{ matrix.platform }} -j$(nproc)

      - name: Verify build output
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          echo "Build output:"
          ls -la *.so *.dll *.dylib *.a *.bc 2>/dev/null || true
          file ${{ env.CORE_NAME }}* 2>/dev/null || echo "No core files found"

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: gearsystem-linux
          path: ${{ env.BUILD_DIR }}/${{ env.CORE_NAME }}.so

  # Windows Build
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2 and GCC
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: |
            base-devel
            git
            mingw-w64-x86_64-toolchain
            make

      - name: Build for Windows
        working-directory: ${{ env.BUILD_DIR }}
        shell: msys2 {0}
        run: |
          make clean
          make platform=win -j$(nproc)

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: gearsystem-windows
          path: ${{ env.BUILD_DIR }}/${{ env.CORE_NAME }}.dll

  # macOS Build
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build for macOS
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          make clean
          make platform=osx -j$(sysctl -n hw.ncpu)

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: gearsystem-macos
          path: ${{ env.BUILD_DIR }}/${{ env.CORE_NAME }}.dylib

  # Raspberry Pi Cross-Compilation (optional)
  build-rpi:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [arm-linux-gnueabihf]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install cross-compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-${{ matrix.target }} g++-${{ matrix.target }}

      - name: Build for Raspberry Pi
        working-directory: ${{ env.BUILD_DIR }}
        env:
          CC: ${{ matrix.target }}-gcc
          CXX: ${{ matrix.target }}-g++
          AR: ${{ matrix.target }}-ar
        run: |
          make clean
          make platform=unix -j$(nproc)

      - name: Upload RPi artifact
        uses: actions/upload-artifact@v4
        with:
          name: gearsystem-rpi-${{ matrix.target }}
          path: ${{ env.BUILD_DIR }}/${{ env.CORE_NAME }}.so

  # Emscripten/Web Build
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.56'

      - name: Build for Web
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          source $EMSDK/emsdk_env.sh
          make clean
          make platform=emscripten -j$(nproc)

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: gearsystem-web
          path: ${{ env.BUILD_DIR }}/${{ env.CORE_NAME }}*.bc

  # Qualitätsprüfung und Zusammenfassung
  verify-builds:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: List all built files
        run: |
          echo "=== ALL BUILT FILES ==="
          find . -type f \( -name "*.so" -o -name "*.dll" -o -name "*.dylib" -o -name "*.a" -o -name "*.bc" \) | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
            echo "- $(basename "$file") (${size} bytes)"
          done

      - name: Check file properties (Linux)
        run: |
          if [ -f "gearsystem-linux/gearsystem_libretro.so" ]; then
            echo "=== LINUX LIBRARY INFO ==="
            file gearsystem-linux/gearsystem_lretro.so
            echo "Dependencies:"
            ldd gearsystem-linux/gearsystem_libretro.so 2>/dev/null || echo "Static or not an ELF"
          fi

  # Release-Paketierung (nur bei Releases)
  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: github.event_name == 'release'

    steps:
      - name: Download main artifacts
        uses: actions/download-artifact@v4

      - name: Create release directory structure
        run: |
          mkdir -p release/cores
          # Copy all core files
          find . -name "*.so" -exec cp {} release/cores/ \;
          find . -name "*.dll" -exec cp {} release/cores/ \;
          find . -name "*.dylib" -exec cp {} release/cores/ \;
          find . -name "*.bc" -exec cp {} release/cores/ \;
          
          # Clean up duplicate names
          cd release/cores
          for file in *; do
            if [[ "$file" =~ gearsystem_libretro.* ]]; then
              # Keep as is
              echo "Keeping: $file"
            else
              # This shouldn't happen
              echo "Unexpected file: $file"
            fi
          done

      - name: Create README
        run: |
          cat > release/README.md << EOF
          # GearSystem Libretro Core
          
          Version: ${{ github.ref_name }}
          Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          Repository: ${{ github.repository }}
          
          ## Available Cores
          
          | Platform | File | Description |
          |----------|------|-------------|
          | Linux | \`gearsystem_libretro.so\` | Standard Linux build |
          | Windows | \`gearsystem_libretro.dll\` | Windows build (MinGW) |
          | macOS | \`gearsystem_libretro.dylib\` | macOS Universal binary |
          | Web | \`gearsystem_libretro_emscripten.bc\` | Emscripten/WebAssembly |
          
          ## Installation
          
          1. Download the appropriate core for your platform
          2. Place it in your RetroArch cores directory:
             - Linux: \`~/.config/retroarch/cores/\`
             - Windows: \`RetroArch/cores/\`
             - macOS: \`~/Library/Application Support/RetroArch/cores/\`
          
          3. Restart RetroArch
          
          ## Source Code
          
          Full source available at: https://github.com/${{ github.repository }}
          
          ## License
          
          [Check the repository for license information]
          EOF

      - name: Create ZIP archive
        run: |
          cd release
          zip -r gearsystem-libretro-${{ github.ref_name }}.zip .

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/gearsystem-libretro-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}